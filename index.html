<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Textastic · Editor profesional</title>
  
  <!-- Monaco Editor assets (CDN) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/monaco-editor@0.39.0/min/vs/editor/editor.main.css" />
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.39.0/min/vs/loader.js"></script>
  
  <!-- Lucide icons (minimal vector icons) -->
  <script src="https://unpkg.com/lucide@latest"></script>
  
  <style>
    /* ----- GLOBAL RESET & VARIABLES (Textastic aesthetic) ----- */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    body {
      background-color: #1e1e1e;
      height: 100vh;
      overflow: hidden;
      color: #d4d4d4;
    }

    .app {
      display: grid;
      grid-template-rows: 48px 1fr;
      height: 100vh;
      width: 100vw;
      background-color: #1e1e1e;
    }

    /* ----- TOPBAR (fija, sobria) ----- */
    .topbar {
      background-color: #2d2d2d;
      border-bottom: 1px solid #333333;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      color: #d4d4d4;
      font-size: 14px;
    }

    .topbar-left {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
      letter-spacing: 0.3px;
    }

    .topbar-left i {
      color: #007acc;
    }

    .topbar-actions {
      display: flex;
      gap: 16px;
    }

    .btn {
      background: transparent;
      border: none;
      color: #d4d4d4;
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 13px;
      font-weight: 450;
      cursor: pointer;
      transition: background 0.1s ease;
    }

    .btn:hover {
      background: #3a3a3a;
    }

    .btn i {
      width: 16px;
      height: 16px;
      stroke-width: 1.8;
    }

    /* ----- WORKSPACE (sidebar + editor) ----- */
    .workspace {
      display: grid;
      grid-template-columns: 280px 1fr;
      overflow: hidden;
      background-color: #1e1e1e;
    }

    /* ----- SIDEBAR (árbol de archivos) ----- */
    .sidebar {
      background-color: #252526;
      border-right: 1px solid #333333;
      overflow-y: auto;
      padding: 16px 0 16px 12px;
      font-size: 13px;
      user-select: none;
    }

    /* Estilo árbol */
    .tree {
      list-style: none;
      margin-left: 0;
      padding-left: 0;
    }

    .tree ul {
      list-style: none;
      padding-left: 20px;
      margin-left: 0;
    }

    .tree li {
      line-height: 28px;
      white-space: nowrap;
      display: flex;
      flex-direction: column;
    }

    .tree-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 0 8px 0 4px;
      border-radius: 4px;
      cursor: pointer;
      color: #cccccc;
      height: 28px;
    }

    .tree-item:hover {
      background-color: #2a2d2e;
    }

    .tree-item.active {
      background-color: #2a3f4f;
      color: white;
    }

    .tree-item i {
      width: 16px;
      height: 16px;
      stroke-width: 1.5;
      flex-shrink: 0;
    }

    .expand-icon {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      cursor: pointer;
      color: #b0b0b0;
    }

    .file-name {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* ----- ÁREA EDITOR (pestañas + monaco) ----- */
    .editor-area {
      display: grid;
      grid-template-rows: 36px 1fr;
      background-color: #1e1e1e;
      overflow: hidden;
    }

    .tabs {
      display: flex;
      background-color: #252526;
      border-bottom: 1px solid #333333;
      overflow-x: auto;
      overflow-y: hidden;
      scrollbar-width: thin;
      scrollbar-color: #4a4a4a #2d2d2d;
    }

    .tabs::-webkit-scrollbar {
      height: 3px;
    }
    .tabs::-webkit-scrollbar-thumb {
      background: #4a4a4a;
    }

    .tab {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 0 12px;
      background-color: #2d2d2d;
      border-right: 1px solid #3e3e3e;
      color: #b0b0b0;
      font-size: 13px;
      height: 36px;
      cursor: pointer;
      white-space: nowrap;
      transition: background 0.1s;
    }

    .tab.active {
      background-color: #1e1e1e;
      color: #ffffff;
      border-bottom: 2px solid #007acc;
    }

    .tab.dirty .tab-label::after {
      content: "●";
      margin-left: 6px;
      font-size: 14px;
      color: #ff9800;
    }

    .tab-close {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      border-radius: 3px;
      color: #b0b0b0;
    }
    .tab-close:hover {
      background-color: #4a4a4a;
      color: white;
    }
    .tab-close i {
      width: 14px;
      height: 14px;
    }

    #editor {
      width: 100%;
      height: 100%;
      background-color: #1e1e1e;
    }

    /* ----- PANTALLA INICIAL (Open Folder grande) ----- */
    .welcome {
      position: absolute;
      top: 48px;
      left: 0;
      width: 100vw;
      height: calc(100vh - 48px);
      background-color: #1e1e1e;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .welcome-card {
      background: #252526;
      padding: 48px 64px;
      border-radius: 12px;
      border: 1px solid #3a3a3a;
      text-align: center;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }

    .welcome-card i {
      width: 48px;
      height: 48px;
      color: #007acc;
      margin-bottom: 24px;
    }

    .welcome-card h2 {
      font-weight: 400;
      font-size: 24px;
      margin-bottom: 28px;
      color: #e0e0e0;
    }

    .btn-open-folder {
      background: #007acc;
      color: white;
      padding: 12px 32px;
      border-radius: 6px;
      font-size: 16px;
      border: none;
      display: inline-flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .btn-open-folder:hover {
      background: #005fa3;
    }

    .hidden {
      display: none !important;
    }

    /* Tipografía monoespaciada para el editor (Monaco ya la incluye) */
    .editor-area {
      font-family: 'Fira Code', 'JetBrains Mono', 'Cascadia Code', monospace;
    }

    /* Pequeño mensaje de guardado */
    .save-toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: #2d2d2d;
      color: #d4d4d4;
      padding: 10px 20px;
      border-radius: 6px;
      border-left: 4px solid #007acc;
      font-size: 13px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      opacity: 0.9;
      pointer-events: none;
      z-index: 200;
      transition: opacity 0.2s;
    }
  </style>
</head>
<body>
<div class="app">

  <!-- TOPBAR FIJA (siempre visible) -->
  <header class="topbar">
    <div class="topbar-left">
      <i data-lucide="code-2" style="color: #007acc;" width="20" height="20"></i>
      <span>Textastic · Professional</span>
    </div>
    <div class="topbar-actions">
      <button id="saveBtn" class="btn" title="Guardar (Ctrl+S)">
        <i data-lucide="save" width="16" height="16"></i>
        <span>Guardar</span>
      </button>
      <button id="openFolderTopbarBtn" class="btn">
        <i data-lucide="folder-open" width="16" height="16"></i>
        <span>Abrir carpeta</span>
      </button>
    </div>
  </header>

  <!-- WORKSPACE (oculto inicialmente) -->
  <div id="workspaceContainer" class="workspace hidden">
    <!-- SIDEBAR con árbol de archivos -->
    <aside class="sidebar" id="sidebar">
      <!-- el árbol se renderiza dinámicamente -->
    </aside>

    <!-- ÁREA EDITOR con pestañas y Monaco -->
    <main class="editor-area">
      <div class="tabs" id="tabsContainer"></div>
      <div id="editor"></div>
    </main>
  </div>

  <!-- PANTALLA INICIAL: Open Folder -->
  <div id="welcomeScreen" class="welcome">
    <div class="welcome-card">
      <i data-lucide="file-text" width="48" height="48" stroke-width="1.5"></i>
      <h2>Abrir carpeta local</h2>
      <button id="welcomeOpenFolderBtn" class="btn-open-folder">
        <i data-lucide="folder-open" width="20" height="20"></i>
        Seleccionar carpeta
      </button>
      <p style="margin-top: 32px; color: #8a8a8a; font-size: 13px;">Editor profesional · Sin servidor</p>
    </div>
  </div>
</div>

<!-- Notificación de guardado -->
<div id="saveToast" class="save-toast hidden">✓ Archivo guardado</div>

<script>
  (async function() {
    // ------ CONFIGURACIÓN MONACO (AMD loader) ------
    const monacoReady = new Promise((resolve) => {
      require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.39.0/min/vs' } });
      require(['vs/editor/editor.main'], function() {
        resolve(window.monaco);
      });
    });
    const monaco = await monacoReady;

    // ------ ESTADO GLOBAL ------
    let rootDirectoryHandle = null;               // FileSystemDirectoryHandle raíz
    const expandedPaths = new Set(['']);          // rutas expandidas ('' = raíz)
    let openFiles = [];                          // archivos abiertos { id, name, handle, model, originalContent, dirty, language, path }
    let activeFileId = null;                    // ID del archivo activo
    let editorInstance = null;                 // instancia Monaco
    const fileHandleMap = new Map();           // ruta -> FileSystemFileHandle (para acceso rápido)

    // Elementos DOM
    const welcomeScreen = document.getElementById('welcomeScreen');
    const workspaceContainer = document.getElementById('workspaceContainer');
    const sidebarEl = document.getElementById('sidebar');
    const tabsContainer = document.getElementById('tabsContainer');
    const saveBtn = document.getElementById('saveBtn');
    const openFolderTopbarBtn = document.getElementById('openFolderTopbarBtn');
    const welcomeOpenFolderBtn = document.getElementById('welcomeOpenFolderBtn');
    const saveToast = document.getElementById('saveToast');

    // Utilidad para mostrar notificación breve
    function showSaveMessage(msg = '✓ Archivo guardado') {
      saveToast.textContent = msg;
      saveToast.classList.remove('hidden');
      setTimeout(() => saveToast.classList.add('hidden'), 2000);
    }

    // Mapeo de extensiones a lenguaje Monaco
    function getLanguageFromExtension(filename) {
      const ext = filename.split('.').pop().toLowerCase();
      const map = {
        js: 'javascript', ts: 'typescript', jsx: 'javascript', tsx: 'typescript',
        html: 'html', css: 'css', json: 'json', md: 'markdown',
        py: 'python', rb: 'ruby', go: 'go', rs: 'rust', java: 'java',
        cpp: 'cpp', c: 'c', php: 'php', xml: 'xml', yaml: 'yaml',
        sh: 'shell', sql: 'sql', swift: 'swift', kt: 'kotlin'
      };
      return map[ext] || 'plaintext';
    }

    // ----- ÁRBOL DE ARCHIVOS (renderizado recursivo asíncrono) -----
    async function renderSidebar() {
      if (!rootDirectoryHandle) return;
      sidebarEl.innerHTML = ''; 
      const treeRoot = await buildTree(rootDirectoryHandle, '');
      sidebarEl.appendChild(treeRoot);
      // refrescar iconos Lucide
      lucide.createIcons();
    }

    // Construye <ul> para un directorio
    async function buildTree(directoryHandle, currentPath) {
      const ul = document.createElement('ul');
      ul.className = 'tree';

      for await (const [name, handle] of directoryHandle.entries()) {
        const li = document.createElement('li');
        const itemPath = currentPath ? `${currentPath}/${name}` : name;
        const div = document.createElement('div');
        div.className = 'tree-item';
        div.dataset.path = itemPath;
        div.dataset.kind = handle.kind;

        // ----- Icono expandir/colapsar (solo directorios) -----
        if (handle.kind === 'directory') {
          const expandSpan = document.createElement('span');
          expandSpan.className = 'expand-icon';
          const isExpanded = expandedPaths.has(itemPath);
          const expandIcon = document.createElement('i');
          expandIcon.dataset.lucide = isExpanded ? 'chevron-down' : 'chevron-right';
          expandSpan.appendChild(expandIcon);
          expandSpan.addEventListener('click', async (e) => {
            e.stopPropagation();
            if (expandedPaths.has(itemPath)) {
              expandedPaths.delete(itemPath);
            } else {
              expandedPaths.add(itemPath);
            }
            await renderSidebar(); // re-render completo
          });
          div.appendChild(expandSpan);
        } else {
          // alinear archivos (espaciado)
          const spacer = document.createElement('span');
          spacer.style.width = '20px';
          spacer.style.display = 'inline-block';
          div.appendChild(spacer);
        }

        // ----- Icono de carpeta / archivo -----
        const icon = document.createElement('i');
        if (handle.kind === 'directory') {
          icon.dataset.lucide = expandedPaths.has(itemPath) ? 'folder-open' : 'folder';
        } else {
          icon.dataset.lucide = 'file';
        }
        div.appendChild(icon);

        // ----- Nombre -----
        const nameSpan = document.createElement('span');
        nameSpan.className = 'file-name';
        nameSpan.textContent = name;
        div.appendChild(nameSpan);

        // ----- Evento click: archivo -> abrir; carpeta (solo icono expande) -----
        if (handle.kind === 'file') {
          div.addEventListener('click', (e) => {
            if (e.target.closest('.expand-icon')) return;
            openFileFromHandle(handle, name, itemPath);
          });
        }

        li.appendChild(div);

        // ----- Hijos recursivos (si directorio y expandido) -----
        if (handle.kind === 'directory' && expandedPaths.has(itemPath)) {
          const childUl = await buildTree(handle, itemPath);
          li.appendChild(childUl);
        }

        ul.appendChild(li);
      }
      return ul;
    }

    // ----- ABRIR ARCHIVO (leer, crear modelo, pestaña) -----
    async function openFileFromHandle(fileHandle, fileName, filePath) {
      try {
        // ¿Ya está abierto?
        const existing = openFiles.find(f => f.path === filePath);
        if (existing) {
          setActiveFile(existing.id);
          return;
        }

        const file = await fileHandle.getFile();
        const content = await file.text();
        const language = getLanguageFromExtension(fileName);
        
        // Crear modelo Monaco
        const model = monaco.editor.createModel(content, language);
        
        const fileId = crypto.randomUUID ? crypto.randomUUID() : Date.now() + '-' + fileName;
        const newFile = {
          id: fileId,
          name: fileName,
          handle: fileHandle,
          model,
          originalContent: content,
          dirty: false,
          language,
          path: filePath
        };

        // Listener de cambios en el modelo
        model.onDidChangeContent(() => {
          const currentContent = model.getValue();
          const isDirty = currentContent !== newFile.originalContent;
          if (newFile.dirty !== isDirty) {
            newFile.dirty = isDirty;
            renderTabs();
            // también actualizar indicador en pestaña activa
          }
        });

        openFiles.push(newFile);
        fileHandleMap.set(filePath, fileHandle);
        setActiveFile(fileId);
        renderTabs();
      } catch (err) {
        console.error('Error al abrir archivo:', err);
        alert('No se pudo leer el archivo. Permiso denegado?');
      }
    }

    // ----- ACTIVAR PESTAÑA Y MODELO EN EDITOR -----
    function setActiveFile(fileId) {
      const file = openFiles.find(f => f.id === fileId);
      if (!file) return;
      activeFileId = fileId;
      if (editorInstance) {
        editorInstance.setModel(file.model);
      }
      renderTabs();
      highlightActiveFileInSidebar(file.path);
    }

    // Resalta archivo activo en sidebar
    function highlightActiveFileInSidebar(path) {
      // quitar clase active de todos
      document.querySelectorAll('.tree-item').forEach(el => el.classList.remove('active'));
      // activar el que coincida
      const activeItem = document.querySelector(`.tree-item[data-path="${path}"]`);
      if (activeItem) activeItem.classList.add('active');
    }

    // ----- RENDER PESTAÑAS -----
    function renderTabs() {
      if (!tabsContainer) return;
      if (openFiles.length === 0) {
        tabsContainer.innerHTML = '';
        if (editorInstance) {
          editorInstance.setModel(monaco.editor.createModel('Selecciona un archivo para empezar a editar', 'plaintext'));
        }
        return;
      }

      let html = '';
      openFiles.forEach(file => {
        const activeClass = (activeFileId === file.id) ? 'active' : '';
        const dirtyClass = file.dirty ? 'dirty' : '';
        html += `<div class="tab ${activeClass} ${dirtyClass}" data-file-id="${file.id}">
          <span class="tab-label">${file.name}</span>
          <span class="tab-close" data-file-id="${file.id}" data-close-tab>
            <i data-lucide="x" width="14" height="14"></i>
          </span>
        </div>`;
      });
      tabsContainer.innerHTML = html;
      
      // Eventos: clic en pestaña activar, clic en cerrar
      tabsContainer.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
          if (e.target.closest('.tab-close')) return;
          const fileId = tab.dataset.fileId;
          setActiveFile(fileId);
        });
      });

      tabsContainer.querySelectorAll('.tab-close').forEach(closeBtn => {
        closeBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          const fileId = closeBtn.dataset.fileId;
          closeTab(fileId);
        });
      });

      lucide.createIcons();
    }

    // ----- CERRAR PESTAÑA (con confirmación si dirty) -----
    async function closeTab(fileId) {
      const fileIndex = openFiles.findIndex(f => f.id === fileId);
      if (fileIndex === -1) return;
      const file = openFiles[fileIndex];
      
      if (file.dirty) {
        const confirmClose = confirm(`Hay cambios sin guardar en ${file.name}. ¿Cerrar igualmente?`);
        if (!confirmClose) return;
      }

      // Dispose del modelo
      file.model.dispose();
      openFiles.splice(fileIndex, 1);
      
      // Si era el activo, activar otro
      if (activeFileId === fileId) {
        if (openFiles.length > 0) {
          setActiveFile(openFiles[0].id);
        } else {
          activeFileId = null;
          editorInstance.setModel(monaco.editor.createModel('Selecciona un archivo para empezar a editar', 'plaintext'));
        }
      }
      renderTabs();
    }

    // ----- GUARDAR ARCHIVO ACTIVO -----
    async function saveActiveFile() {
      if (!activeFileId) {
        showSaveMessage('✗ No hay archivo activo');
        return;
      }
      const file = openFiles.find(f => f.id === activeFileId);
      if (!file) return;
      
      try {
        const writable = await file.handle.createWritable();
        const content = file.model.getValue();
        await writable.write(content);
        await writable.close();
        
        // Actualizar contenido original y marcar como limpio
        file.originalContent = content;
        file.dirty = false;
        renderTabs();
        showSaveMessage(`✓ ${file.name} guardado`);
      } catch (err) {
        console.error('Error al guardar:', err);
        alert('No se pudo guardar el archivo. Permiso revocado?');
      }
    }

    // ----- ABRIR CARPETA (showDirectoryPicker) -----
    async function openFolder() {
      if (!window.showDirectoryPicker) {
        alert('La File System Access API no está soportada en este navegador. Usa Chrome/Edge 86+');
        return;
      }
      
      // Si hay archivos sin guardar, preguntar
      if (openFiles.some(f => f.dirty)) {
        const confirm = window.confirm('Hay cambios sin guardar. ¿Abrir otra carpeta? Se perderán los cambios no guardados.');
        if (!confirm) return;
      }
      
      try {
        const dirHandle = await window.showDirectoryPicker();
        rootDirectoryHandle = dirHandle;
        
        // Resetear estado
        openFiles.forEach(f => f.model.dispose());
        openFiles = [];
        activeFileId = null;
        expandedPaths.clear();
        expandedPaths.add(''); // raíz expandida
        fileHandleMap.clear();
        
        // Mostrar workspace, ocultar welcome
        welcomeScreen.classList.add('hidden');
        workspaceContainer.classList.remove('hidden');
        
        // Inicializar editor si no existe
        if (!editorInstance) {
          editorInstance = monaco.editor.create(document.getElementById('editor'), {
            value: 'Selecciona un archivo para empezar a editar',
            language: 'plaintext',
            theme: 'vs-dark',
            automaticLayout: true,
            fontSize: 14,
            fontFamily: 'Fira Code, JetBrains Mono, Cascadia Code, monospace',
            minimap: { enabled: false },
            scrollBeyondLastLine: false
          });
        } else {
          editorInstance.setModel(monaco.editor.createModel('Selecciona un archivo para empezar a editar', 'plaintext'));
        }

        await renderSidebar();
        renderTabs();
      } catch (err) {
        if (err.name === 'AbortError') return; // usuario canceló
        console.error('Error al abrir carpeta:', err);
        alert('No se pudo abrir la carpeta.');
      }
    }

    // ----- EVENT LISTENERS -----
    welcomeOpenFolderBtn.addEventListener('click', openFolder);
    openFolderTopbarBtn.addEventListener('click', openFolder);
    saveBtn.addEventListener('click', saveActiveFile);

    // Ctrl + S global
    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        saveActiveFile();
      }
    });

    // Inicial: mostrar bienvenida, workspace oculto
    // Monaco listo, creamos editor vacío (pero oculto)
    editorInstance = monaco.editor.create(document.getElementById('editor'), {
      value: 'Selecciona una carpeta para comenzar',
      language: 'plaintext',
      theme: 'vs-dark',
      automaticLayout: true,
      fontFamily: 'Fira Code, JetBrains Mono, monospace',
      minimap: { enabled: false }
    });
    workspaceContainer.classList.add('hidden'); // aseguramos

    // Iconos iniciales
    lucide.createIcons();
  })();
</script>

</body>
</html>
